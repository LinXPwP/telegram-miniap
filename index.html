<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><title>MiniApp Shop & Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />
</head>
<body data-page="user">
  <div class="app-wrapper" id="mainAppWrapper">
    <div id="shopHeader" class="header-bar">
      <div class="header-left">
        <button class="btn-icon-back" id="shopBackBtn" style="display: none;">
             <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
             <span class="back-btn-text"></span>
        </button>
        <div class="brand-logo" id="headerTitle">
            <img src="logo.png" class="header-logo-img" alt="R"><span class="brand-text-suffix">3DG3N</span>
        </div>
      </div>
      <div class="header-right">
        <button class="btn-icon" id="goToPurchasesBtn" aria-label="Orders">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
        </button>
        <button class="credits-pill-btn" id="creditsBtn">
          <span class="label">CRD:</span><span class="value" id="creditsValue">0</span><span class="add-icon">+</span>
        </button>
        <button class="btn-icon" id="goToTicketsBtn" aria-label="Tickets">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
        </button>
      </div>
    </div>
    <div class="user-info-bar" id="userLine"></div>

    <main class="main-content">
      <div id="shopTab" class="tab-section active">
        <div id="viewCategories" class="shop-view active-view">
          <div class="hero-banner"><h1>Discover</h1><p>Choose a category to start.</p></div>
          <div id="categoriesGrid" class="visual-grid"></div>
          <div class="shop-footer-note">RedGen Visual v3.0</div>
        </div>
        <div id="viewProducts" class="shop-view">
           <div id="productsGrid" class="visual-grid"></div>
           <div class="empty-products-msg" id="emptyProductsMsg" style="display:none">No products found here.</div>
        </div>
      </div>

      <div id="purchasesTab" class="tab-section">
          <div class="header-bar" style="background:var(--bg-surface); border-bottom:1px solid rgba(255,255,255,0.05);">
              <div class="header-left"><button class="btn-icon-back" id="backFromPurchases"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg><span class="back-btn-text">Back</span></button></div>
              <div class="header-right" style="font-weight:700;">My Orders</div>
          </div>
          <div class="chat-viewport" id="purchasesList" style="padding:16px;">
              </div>
      </div>

      <div id="ticketsTab" class="tab-section chat-mode">
        <div class="chat-layout">
          <div class="chat-sidebar" id="chatList"></div>
          <div class="chat-main">
            <div class="chat-navbar" id="chatHeader">
              <div class="nav-left">
                <button class="menu-toggle" id="ticketsMenuToggle"><span></span><span></span><span></span></button>
                <div class="chat-info"><div class="chat-title" id="ticketTitle">No ticket</div></div>
              </div>
              <div class="nav-right">
                <button class="btn-sm btn-danger-ghost" id="userTicketCloseBtn" style="display:none;">Close</button>
              </div>
            </div>
            <div class="chat-viewport" id="chatMessages">
              <div class="chat-placeholder"><div class="icon">üí¨</div><p>Open menu and select a ticket.</p></div>
            </div>
            <div class="chat-footer chat-input" id="chatFooter">
              <div class="input-wrapper">
                <input id="chatInput" type="text" placeholder="Type a message..." autocomplete="off" disabled />
                <button id="chatSendBtn" class="btn-send" disabled><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
              </div>
              <button class="btn-block-back" id="backToShopBtn"><span style="margin-right: 6px;">&larr;</span> Back to Shop</button>
            </div>
          </div>
        </div>
        <div class="tickets-backdrop" id="ticketsBackdrop"></div>
      </div>
    </main>

    <div id="productPanel" class="modal-overlay">
      <div class="modal-card">
        <button class="modal-close" id="panelCloseBtn">&times;</button>
        <div class="modal-top-split">
            <div class="modal-img-wrapper"><img id="panelImg" src="" alt="Product" onerror="this.style.display='none'"><div class="modal-img-placeholder" id="panelImgPlaceholder">üéÅ</div></div>
            <div class="modal-header-compact"><h2 id="panelName">Product Name</h2><div class="modal-price" id="panelPrice">0 CRD</div></div>
        </div>
        <div class="modal-body">
            <div id="panelTypesContainer" class="types-section" style="display:none;"><div class="types-label">Choose Variant:</div><div id="panelTypesGrid" class="types-grid"></div></div>
            <div class="desc-container"><div class="desc-label">Description:</div><p class="modal-desc" id="panelDesc"></p></div>
            <div class="status-message" id="panelStatus"></div>
        </div>
        <div class="modal-footer"><button class="btn-primary full-width" id="panelBuyBtn">Buy Now</button></div>
      </div>
    </div>

    <div id="confirmActionModal" class="modal-overlay">
      <div class="modal-card" style="text-align: center;">
        <div class="modal-header"><h2 style="font-size:18px; margin-bottom:5px;">Confirmation</h2></div>
        <div class="modal-body"><p class="modal-desc">Are you sure you want to close this ticket?</p></div>
        <div class="modal-footer modal-actions-grid">
          <button class="btn-secondary" id="confirmCancelBtn">Cancel</button>
          <button class="btn-primary btn-danger-solid" id="confirmOkBtn">Close Ticket</button>
        </div>
      </div>
    </div>

    <div id="claimWarrantyModal" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><h2 style="color: var(--accent);">Claim Warranty</h2></div>
            <div class="modal-body">
                <p class="modal-desc" style="margin-bottom:12px;">Please describe the issue with your product to open a support ticket:</p>
                <div class="input-wrapper" style="border-radius:12px; padding:10px; background:rgba(0,0,0,0.2);">
                    <textarea id="claimReasonInput" rows="4" style="width:100%; background:transparent; border:none; color:#fff; resize:none; font-family:inherit; outline:none;" placeholder="E.g. The account is invalid..."></textarea>
                </div>
                <div class="status-message" id="claimStatus" style="margin-top:10px;"></div>
            </div>
            <div class="modal-footer modal-actions-grid" style="margin-top:20px;">
                <button class="btn-secondary" id="claimCancelBtn">Cancel</button>
                <button class="btn-primary" id="claimSubmitBtn">Submit Claim</button>
            </div>
        </div>
    </div>

    <div id="creditsModal" class="modal-overlay">
        <div class="modal-card">
            <button class="modal-close" id="closeCreditsModalBtn">&times;</button>
            <div class="modal-header"><h2 style="color: var(--accent);">Add Funds</h2></div>
            
            <div class="modal-body" style="padding: 0 4px;">
                
                <div id="step-1-packages" class="wizard-step">
                    <p class="modal-desc" style="text-align:center;">Select a credit package or enter custom amount.</p>
                    <div class="packages-grid">
                        <div class="credit-pack-card" onclick="CreditsWizard.selectPack(110, 5, 'pkg1')">
                            <div class="pack-badge">+10 Bonus</div>
                            <div class="pack-amount">110 CRD</div>
                            <div class="pack-price">$5.00</div>
                        </div>
                        <div class="credit-pack-card popular" onclick="CreditsWizard.selectPack(240, 10, 'pkg2')">
                            <div class="pack-badge">Best Value</div>
                            <div class="pack-amount">240 CRD</div>
                            <div class="pack-price">$10.00</div>
                        </div>
                        <div class="credit-pack-card" onclick="CreditsWizard.selectPack(500, 20, 'pkg3')">
                            <div class="pack-badge">+100 Bonus</div>
                            <div class="pack-amount">500 CRD</div>
                            <div class="pack-price">$20.00</div>
                        </div>
                    </div>
                    
                    <div class="custom-amount-box">
                        <div class="desc-label">OR Custom Amount ($1 = 20 CRD)</div>
                        <div class="custom-input-row">
                            <div class="input-wrapper" style="flex:1;">
                                <input type="number" id="customAmountInput" placeholder="USD Amount" min="1" step="1">
                            </div>
                            <div class="custom-arrow">&rarr;</div>
                            <div class="custom-result" id="customAmountResult">0 CRD</div>
                        </div>
                    </div>

                    <button class="btn-primary full-width" id="btnNextToMethod" style="margin-top:16px;">Next Step</button>
                </div>

                <div id="step-2-method" class="wizard-step" style="display:none;">
                    <p class="modal-desc" style="text-align:center;">Select Payment Method</p>
                    <div class="summary-pill" id="step2Summary">Total: $0.00</div>
                    
                    <div class="methods-list">
                        <div class="method-card" onclick="CreditsWizard.selectMethod('paypal')">
                            <div class="method-icon" style="color:#003087">P</div>
                            <div class="method-name">PayPal (F&F Only)</div>
                            <div class="type-radio-circle"></div>
                        </div>
                        <div class="method-card" onclick="CreditsWizard.selectMethod('binance')">
                            <div class="method-icon" style="color:#F3BA2F">B</div>
                            <div class="method-name">Binance Pay</div>
                            <div class="type-radio-circle"></div>
                        </div>
                        <div class="method-card" onclick="CreditsWizard.selectMethod('ltc')">
                            <div class="method-icon" style="color:#345D9D">L</div>
                            <div class="method-name">Litecoin (LTC)</div>
                            <div class="type-radio-circle"></div>
                        </div>
                        <div class="method-card" onclick="CreditsWizard.selectMethod('btc')">
                            <div class="method-icon" style="color:#F7931A">‚Çø</div>
                            <div class="method-name">Bitcoin (BTC)</div>
                            <div class="type-radio-circle"></div>
                        </div>
                    </div>

                    <div class="modal-actions-grid" style="margin-top:20px;">
                        <button class="btn-secondary" onclick="CreditsWizard.goBack(1)">Back</button>
                        <button class="btn-primary" id="btnNextToDetails" disabled>Next</button>
                    </div>
                </div>

                <div id="step-3-details" class="wizard-step" style="display:none;">
                    <h3 id="detailsTitle" style="text-align:center; font-size:16px; margin:0 0 10px 0;">Payment Details</h3>
                    
                    <div id="paymentAlertBox" class="payment-alert" style="display:none;">
                        <b>WARNING:</b> You MUST use <b>Friends & Family</b>. If you use Goods & Services, the payment will be rejected and funds may be lost.
                    </div>

                    <div class="payment-info-box">
                        <span class="info-label">Send Exactly:</span>
                        <div class="info-value-big" id="payAmountDisplay">$0.00</div>
                    </div>

                    <div class="payment-info-box">
                        <span class="info-label" id="payDestLabel">Email:</span>
                        <div class="copy-row">
                            <div class="code-box" id="payDestValue">...</div>
                            <button class="btn-copy" onclick="copyToClip('payDestValue')">üìã</button>
                        </div>
                    </div>

                    <div id="proofSection">
                        <div class="desc-label" style="margin-top:15px; text-align:center;">Verification Required</div>
                        <p class="modal-desc" style="font-size:12px; text-align:center; margin-bottom:10px;">
                            Since you have no previous successful payments, please upload a screenshot of the transaction.
                        </p>
                        
                        <label for="proofFileInput" class="file-upload-zone" id="fileUploadZone">
                            <div class="upload-icon">üì∑</div>
                            <span id="uploadText">Tap to upload screenshot</span>
                        </label>
                        <input type="file" id="proofFileInput" accept="image/*" style="display:none;">
                    </div>

                    <div id="knownUserSection" style="display:none; text-align:center; margin-top:15px;">
                        <p class="modal-desc" style="color:var(--success);">Trusted User Status Active</p>
                        <p class="modal-desc" style="font-size:12px;">You don't need to upload a screenshot. Just click confirm below.</p>
                    </div>

                    <div class="status-message" id="paymentStatus"></div>

                    <div class="modal-actions-grid" style="margin-top:20px;">
                        <button class="btn-secondary" onclick="CreditsWizard.goBack(2)">Back</button>
                        <button class="btn-primary" id="btnSubmitPayment">I Have Paid</button>
                    </div>
                </div>

                <div id="step-4-success" class="wizard-step" style="display:none; text-align:center; padding:20px 0;">
                    <div style="font-size:50px; margin-bottom:10px;">‚úÖ</div>
                    <h3 style="color:var(--success); margin:0;">Request Sent!</h3>
                    <p class="modal-desc" style="margin-top:10px;">
                        An administrator will verify your payment within 24 hours.<br>
                        Your credits will be added automatically.
                    </p>
                    <button class="btn-primary full-width" onclick="document.getElementById('creditsModal').style.display='none'">Close</button>
                </div>

            </div>
        </div>
    </div>
  </div> 
  
  <div id="onlyTelegramError" class="access-error-screen" style="display: none;">
    <div class="error-card">
        <div class="lock-icon-wrapper"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg><div class="lock-glow"></div></div>
        <h2>Restricted Access</h2><p>This application runs exclusively within the Telegram ecosystem.</p>
        <div class="error-actions-modern"><a href="https://t.me/r3dtest_bot" class="btn-modern btn-tg-gradient"><span>Open Bot</span></a></div>
    </div>
  </div>

  <div id="linkAccountError" class="access-error-screen" style="display: none;">
    <div class="error-card">
        <div class="lock-icon-wrapper">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
             <div class="lock-glow" style="background: radial-gradient(circle, rgba(88, 101, 242, 0.4) 0%, transparent 70%);"></div>
        </div>
        <h2>Connection Required</h2><p>To access this shop, you must link your Discord account.</p>
        <div class="instructions-list" style="margin-bottom:20px; text-align:left;">
             <div class="instruction-step" style="border:none; background:rgba(255,255,255,0.05);"><span class="step-num" style="background:#5865F2;">1</span><span>Join our Discord Server.</span></div>
             <div class="instruction-step" style="border:none; background:rgba(255,255,255,0.05);"><span class="step-num" style="background:#5865F2;">2</span><span>Type command <code style="background:#000;padding:2px 5px;border-radius:4px;color:#fff;">/linkaccount</code></span></div>
        </div>
        <div class="error-actions-modern"><a href="https://discord.gg/gc2VGGakQM" target="_blank" class="btn-modern btn-discord-solid"><span>Join Discord</span></a></div>
    </div>
  </div>
  <script src="app.js"></script>
</body>
</html>
