<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Shop – MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-brand">
        <div class="brand-logo"><span>S</span></div>
        <div class="brand-text">
          <h1>Shop</h1>
          <p id="subtitle">Se încarcă datele...</p>
        </div>
      </div>
      <div id="role-chip" class="role-chip" style="display:none;">
        <span class="role-dot"></span>
        <span id="role-text">USER</span>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Balance</div>
          <div class="card-sub">Creditele tale disponibile</div>
        </div>
        <div id="user-id" class="badge-id">ID: -</div>
      </div>

      <div class="info-row">
        <div class="info-label">Username</div>
        <div id="username" class="info-value">loading...</div>
      </div>

      <div class="info-row">
        <div class="info-label">Credite</div>
        <div id="credits" class="info-value credits">0</div>
      </div>

      <div id="profile-error" class="error-text" style="display:none;"></div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Produse</div>
          <div class="card-sub">Cumpără folosind creditele tale</div>
        </div>
      </div>
      <div id="shop-container">
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line short"></div>
      </div>
    </section>

    <div class="footer">
      Navighează: Shop • Profil • Admin (doar admin)
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <nav class="tabbar" style="margin-top:8px;">
    <a class="tab-btn active">Shop</a>
    <a class="tab-btn" href="profile.html">Profil</a>
    <a id="nav-admin" class="tab-btn hidden" href="profile.html#admin">Admin</a>
  </nav>

  <script>
    console.log("Hello, JavaScript!");
    (function () {
      const tg = window.Telegram.WebApp;
      if (tg && tg.expand) tg.expand();

      const ADMIN_ID = 7672256597;
      const API_BASE = "https://melodic-mandazi-7a16dc.netlify.app/.netlify/functions";

      const elSubtitle = document.getElementById("subtitle");
      const elUsername = document.getElementById("username");
      const elCredits = document.getElementById("credits");
      const elUserId = document.getElementById("user-id");
      const elRoleChip = document.getElementById("role-chip");
      const elRoleText = document.getElementById("role-text");
      const elProfileError = document.getElementById("profile-error");
      const elShopContainer = document.getElementById("shop-container");
      const navAdmin = document.getElementById("nav-admin");
      const toastEl = document.getElementById("toast");

      function toast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 2000);
      }

      function safeFetch(url) {
        return fetch(url).then(res => {
          if (!res.ok) return res.text().then(t => { throw new Error(t || res.status); });
          return res.json();
        });
      }

      let user = null;
      try {
        user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
      } catch (e) {
        console.error(e);
      }

      if (!user) {
        elSubtitle.textContent = "Deschide miniapp-ul din Telegram, nu direct din browser.";
        elProfileError.style.display = "block";
        elProfileError.textContent = "User necunoscut.";
        elCredits.textContent = "–";
        return;
      }

      const fullUsername = user.username ? "@" + user.username : "(fără username)";
      const fullName = [user.first_name || "", user.last_name || ""].join(" ").trim();

      elUsername.textContent = fullUsername + (fullName ? " • " + fullName : "");
      elUserId.textContent = "ID: " + user.id;

      const isAdmin = user.id === ADMIN_ID;
      if (isAdmin) {
        elRoleChip.style.display = "inline-flex";
        elRoleText.textContent = "ADMIN";
        navAdmin.classList.remove("hidden");
      }

      elSubtitle.textContent = "Se încarcă creditele & shop-ul...";

      // credite
      safeFetch(API_BASE + "/get_credits?user_id=" + encodeURIComponent(user.id))
        .then(data => {
          elCredits.textContent = data.credits ?? 0;
          if (data.is_admin) {
            elRoleChip.style.display = "inline-flex";
            elRoleText.textContent = "ADMIN";
            navAdmin.classList.remove("hidden");
          }
          elSubtitle.textContent = "Gata! Poți cumpăra produse.";
        })
        .catch(err => {
          console.error(err);
          elCredits.textContent = "–";
          elProfileError.style.display = "block";
          elProfileError.textContent = "Nu s-au putut încărca creditele.";
          elSubtitle.textContent = "Eroare la API-ul de credite.";
        });

      // shop
      safeFetch(API_BASE + "/get_shop")
        .then(data => {
          renderShop(data);
        })
        .catch(err => {
          console.error(err);
          elShopContainer.innerHTML =
            '<div class="error-text">Eroare la încărcarea produselor.</div>';
        });

      function renderShop(data) {
        if (!data || !Array.isArray(data.categories) || !data.categories.length) {
          elShopContainer.innerHTML =
            '<div class="info-value" style="font-size:13px; color:var(--muted);">Momentan nu există produse.</div>';
          return;
        }

        elShopContainer.innerHTML = "";
        let index = 1;

        data.categories.forEach(cat => {
          const catBlock = document.createElement("div");
          catBlock.className = "category-block";

          const header = document.createElement("div");
          header.className = "category-header";

          const nameEl = document.createElement("div");
          nameEl.className = "category-name";
          nameEl.textContent = cat.name || "Categorie";

          const descEl = document.createElement("div");
          descEl.className = "category-desc";
          descEl.textContent = cat.description || "";

          header.appendChild(nameEl);
          header.appendChild(descEl);
          catBlock.appendChild(header);

          (cat.products || []).forEach(prod => {
            const prodDiv = document.createElement("div");
            prodDiv.className = "product-item";

            const top = document.createElement("div");
            top.className = "product-top";

            const pName = document.createElement("div");
            pName.className = "product-name";
            pName.textContent = "#" + index + " · " + (prod.name || "Produs");

            const pPrice = document.createElement("div");
            pPrice.className = "product-price";
            pPrice.textContent = (prod.price || 0) + " cr.";

            top.appendChild(pName);
            top.appendChild(pPrice);
            prodDiv.appendChild(top);

            if (prod.description) {
              const pDesc = document.createElement("div");
              pDesc.className = "product-desc";
              pDesc.textContent = prod.description;
              prodDiv.appendChild(pDesc);
            }

            const bottomRow = document.createElement("div");
            bottomRow.style.display = "flex";
            bottomRow.style.justifyContent = "space-between";
            bottomRow.style.alignItems = "center";
            bottomRow.style.marginTop = "4px";

            const limits = document.createElement("div");
            limits.className = "product-limits";
            limits.textContent =
              "Cantitate: " +
              (prod.min_qty || 1) +
              " - " +
              (prod.max_qty || prod.min_qty || 1);

            const actions = document.createElement("div");

            const btnView = document.createElement("button");
            btnView.className = "btn btn-secondary";
            btnView.textContent = "Detalii";
            btnView.onclick = () => {
              const url =
                "product.html?id=" +
                encodeURIComponent(prod.id) +
                "&idx=" +
                index;
              window.location.href = url;
            };

            const btnBuy = document.createElement("button");
            btnBuy.className = "btn btn-primary";
            btnBuy.textContent = "Cumpără";
            btnBuy.onclick = () => {
              const url =
                "product.html?id=" +
                encodeURIComponent(prod.id) +
                "&idx=" +
                index;
              window.location.href = url;
            };

            actions.appendChild(btnView);
            actions.appendChild(btnBuy);

            bottomRow.appendChild(limits);
            bottomRow.appendChild(actions);
            prodDiv.appendChild(bottomRow);

            catBlock.appendChild(prodDiv);
            index++;
          });

          elShopContainer.appendChild(catBlock);
        });
      }
    })();
  </script>
</body>
</html>
