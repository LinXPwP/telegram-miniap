<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>MiniApp Shop & Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root {
      --bg: #050509;
      --bg-card: #111111;
      --accent: #e50914;
      --accent-soft: #ff4b5c;
      --accent-muted: #8b0000;
      --text: #f5f5f5;
      --muted: #aaaaaa;
      --border: #222222;
      --bubble-user: #1f2933;
      --bubble-admin: #8b0000;
      --bubble-system: #333333;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1a1a1a 0, #000 55%, #050509 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 520px;
      margin: 0 auto;
      padding: 10px 8px 16px;
    }

    .card {
      background: rgba(10, 10, 14, 0.96);
      border-radius: 18px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(229, 9, 20, 0.5);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: radial-gradient(
        circle at top left,
        var(--accent-soft),
        var(--accent)
      );
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #fff;
    }

    .credits {
      text-align: right;
      font-size: 12px;
    }

    .credits span.value {
      font-weight: 700;
      color: var(--accent-soft);
    }

    h1 {
      margin: 4px 0 2px;
      font-size: 18px;
    }

    .subtitle {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .user-line {
      font-size: 12px;
      margin-bottom: 6px;
      color: var(--muted);
    }

    .user-line b {
      color: var(--text);
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    .tab-btn {
      flex: 1;
      font-size: 12px;
      padding: 6px 4px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #080808;
      color: var(--muted);
      cursor: pointer;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      border-color: transparent;
      font-weight: 600;
    }

    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 4px 0;
    }

    /* SHOP */

    .categories {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }

    .category {
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 8px;
      background: linear-gradient(135deg, #141414, #0b0b0f);
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .category-name {
      font-size: 13px;
      font-weight: 600;
    }

    .category-pill {
      font-size: 10px;
      text-transform: uppercase;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--accent-muted);
      color: var(--accent-soft);
    }

    .category-desc {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .products {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .product {
      border-radius: 10px;
      border: 1px solid #252525;
      padding: 6px 7px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: radial-gradient(circle at left, #181818, #080808);
    }

    .product-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      max-width: 70%;
    }

    .product-name {
      font-size: 13px;
      font-weight: 600;
    }

    .product-desc {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-price {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent-soft);
    }

    .product-btn {
      font-size: 11px;
      padding: 5px 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .product-panel {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid var(--accent-muted);
      padding: 8px 8px 10px;
      background: radial-gradient(circle at top, #1b0b0b, #080606);
    }

    .product-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .product-panel-name {
      font-size: 14px;
      font-weight: 700;
    }

    .product-panel-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
    }

    .product-panel-desc {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .product-panel-price {
      font-size: 12px;
      margin-bottom: 6px;
    }

    .qty-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .qty-row input {
      width: 70px;
      padding: 5px 5px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      font-size: 12px;
      text-align: center;
    }

    .product-panel-buy {
      width: 100%;
      padding: 7px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
    }

    .status-bar {
      margin-top: 6px;
      font-size: 11px;
      min-height: 14px;
      color: var(--muted);
    }
    .status-ok {
      color: #4caf50;
    }
    .status-error {
      color: #ff5252;
    }

    /* CHAT */

    .chat-layout {
      display: grid;
      grid-template-columns: 0.9fr 1.6fr;
      gap: 6px;
      max-height: 360px;
    }

    .chat-sidebar {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #08080b;
      overflow: auto;
      font-size: 12px;
    }

    .chat-item {
      padding: 6px 6px;
      border-bottom: 1px solid #151515;
      cursor: pointer;
    }

    .chat-item.active {
      background: rgba(229, 9, 20, 0.25);
      border-left: 3px solid var(--accent-soft);
    }

    .chat-item-title {
      font-weight: 600;
      font-size: 12px;
    }

    .chat-item-line {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-main {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #050509;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 6px 8px;
      border-bottom: 1px solid #151515;
      font-size: 12px;
    }

    .chat-header span {
      color: var(--muted);
    }

    .chat-messages {
      flex: 1;
      padding: 6px 6px 4px;
      overflow-y: auto;
      font-size: 12px;
    }

    .msg-row {
      margin-bottom: 4px;
      display: flex;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-row.admin {
      justify-content: flex-start;
    }

    .msg-row.system {
      justify-content: center;
    }

    .msg-bubble {
      max-width: 80%;
      padding: 5px 7px;
      border-radius: 12px;
      position: relative;
      font-size: 12px;
      line-height: 1.3;
    }

    .msg-bubble.user {
      background: var(--bubble-user);
      border-bottom-right-radius: 2px;
    }

    .msg-bubble.admin {
      background: var(--bubble-admin);
      border-bottom-left-radius: 2px;
    }

    .msg-bubble.system {
      background: var(--bubble-system);
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
    }

    .msg-meta {
      font-size: 9px;
      opacity: 0.7;
      margin-top: 2px;
      text-align: right;
    }

    .chat-input {
      border-top: 1px solid #151515;
      padding: 4px 4px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .chat-input input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 5px 8px;
      font-size: 12px;
    }

    .chat-input button {
      border-radius: 999px;
      border: none;
      padding: 6px 9px;
      font-size: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      cursor: pointer;
    }

    .tickets-info {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dot-red {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header-top">
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Shop & Chat</span>
        </div>
        <div class="credits">
          Credite: <span class="value" id="creditsValue">-</span>
        </div>
      </div>

      <h1>MiniApp Shop</h1>
      <p class="subtitle">
        Cumpără produse cu credite și discută cu administratorul în chat pentru fiecare comandă.
      </p>

      <p class="user-line" id="userLine">Se încarcă utilizatorul...</p>

      <div class="tabs">
        <button class="tab-btn active" data-tab="shopTab">Shop</button>
        <button class="tab-btn" data-tab="ticketsTab">Tichete</button>
      </div>

      <!-- SHOP TAB -->
      <div id="shopTab" class="tab-section active">
        <div class="section-title">Categorii & produse</div>
        <div id="categoriesContainer" class="categories"></div>

        <div id="productPanel" class="product-panel" style="display: none;">
          <div class="product-panel-header">
            <div class="product-panel-name" id="panelName"></div>
            <button class="product-panel-close" id="panelCloseBtn">×</button>
          </div>
          <div class="product-panel-desc" id="panelDesc"></div>
          <div class="product-panel-price" id="panelPrice"></div>
          <div class="qty-row">
            <span style="font-size: 12px;">Cantitate:</span>
            <input type="number" id="panelQty" min="1" value="1" />
            <span id="panelQtyRange" style="font-size: 11px; color: var(--muted);"></span>
          </div>
          <button class="product-panel-buy" id="panelBuyBtn">
            Cumpără și deschide tichet
          </button>
          <div class="status-bar" id="panelStatus"></div>
        </div>
      </div>

      <!-- TICKETS TAB -->
      <div id="ticketsTab" class="tab-section">
        <div class="section-title">Chat-uri tichete</div>
        <div class="chat-layout">
          <div class="chat-sidebar" id="chatList"></div>
          <div class="chat-main">
            <div class="chat-header" id="chatHeader">
              <span>Niciun tichet selectat</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input
                id="chatInput"
                placeholder="Scrie un mesaj către admin..."
                autocomplete="off"
              />
              <button id="chatSendBtn">Trimite</button>
            </div>
          </div>
        </div>
        <div class="tickets-info" id="ticketsInfo"></div>
      </div>

      <div class="footer">
        <span>v0.3 – shop + chat</span>
        <span class="dot-red"></span>
      </div>
    </div>
  </div>

  <script>
    const API_URL =
      "https://dancing-hotteok-480e3c.netlify.app/.netlify/functions/api";

    const tg = window.Telegram?.WebApp;

    let CURRENT_USER = null;
    let CURRENT_SHOP = null;
    let CURRENT_TICKETS = [];
    let SELECTED_TICKET_ID = null;
    let POLL_INTERVAL = null;

    const creditsValueEl = document.getElementById("creditsValue");
    const userLineEl = document.getElementById("userLine");

    // Tabs
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const target = btn.getAttribute("data-tab");
        document
          .querySelectorAll(".tab-section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });
    });

    // API helper
    function apiCall(action, extraPayload = {}) {
      const payload = {
        action,
        user: CURRENT_USER,
        ...extraPayload,
      };
      return fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }).then((r) => r.json());
    }

    // RENDER USER HEADER
    function renderUserHeader() {
      if (!CURRENT_USER) return;
      creditsValueEl.textContent = CURRENT_USER.credits;
      const name =
        CURRENT_USER.username && CURRENT_USER.username !== "fara_username"
          ? "@" + CURRENT_USER.username
          : `ID ${CURRENT_USER.id}`;
      userLineEl.innerHTML = `Utilizator: <b>${name}</b>`;
    }

    // SHOP RENDER
    const categoriesContainer = document.getElementById("categoriesContainer");
    const productPanelEl = document.getElementById("productPanel");
    const panelNameEl = document.getElementById("panelName");
    const panelDescEl = document.getElementById("panelDesc");
    const panelPriceEl = document.getElementById("panelPrice");
    const panelQtyEl = document.getElementById("panelQty");
    const panelQtyRangeEl = document.getElementById("panelQtyRange");
    const panelBuyBtn = document.getElementById("panelBuyBtn");
    const panelCloseBtn = document.getElementById("panelCloseBtn");
    const panelStatusEl = document.getElementById("panelStatus");
    let SELECTED_PRODUCT = null;

    function renderShop(shop) {
      categoriesContainer.innerHTML = "";
      if (!shop || !shop.categories) return;

      shop.categories.forEach((cat) => {
        const catDiv = document.createElement("div");
        catDiv.className = "category";

        const header = document.createElement("div");
        header.className = "category-header";

        const nameSpan = document.createElement("div");
        nameSpan.className = "category-name";
        nameSpan.textContent = cat.name;

        const pill = document.createElement("div");
        pill.className = "category-pill";
        pill.textContent = "categorie";

        header.appendChild(nameSpan);
        header.appendChild(pill);

        const desc = document.createElement("div");
        desc.className = "category-desc";
        desc.textContent = cat.description || "";

        const productsDiv = document.createElement("div");
        productsDiv.className = "products";

        (cat.products || []).forEach((prod) => {
          const prodDiv = document.createElement("div");
          prodDiv.className = "product";

          const main = document.createElement("div");
          main.className = "product-main";

          const title = document.createElement("div");
          title.className = "product-name";
          title.textContent = prod.name;

          const pdesc = document.createElement("div");
          pdesc.className = "product-desc";
          pdesc.textContent = prod.description || "";

          main.appendChild(title);
          main.appendChild(pdesc);

          const right = document.createElement("div");
          right.style.textAlign = "right";

          const price = document.createElement("div");
          price.className = "product-price";
          price.textContent = prod.price + " credite";

          const btn = document.createElement("button");
          btn.className = "product-btn";
          btn.textContent = "Detalii";
          btn.onclick = () => openProductPanel(prod);

          right.appendChild(price);
          right.appendChild(btn);

          prodDiv.appendChild(main);
          prodDiv.appendChild(right);

          productsDiv.appendChild(prodDiv);
        });

        catDiv.appendChild(header);
        catDiv.appendChild(desc);
        catDiv.appendChild(productsDiv);

        categoriesContainer.appendChild(catDiv);
      });
    }

    function openProductPanel(prod) {
      SELECTED_PRODUCT = prod;
      panelStatusEl.textContent = "";
      panelStatusEl.className = "status-bar";

      panelNameEl.textContent = prod.name;
      panelDescEl.textContent = prod.description || "";
      panelPriceEl.textContent = `Preț: ${prod.price} credite / buc.`;

      const min = prod.min_qty || 1;
      const max = prod.max_qty || min;

      panelQtyEl.min = min;
      panelQtyEl.max = max;
      panelQtyEl.value = min;
      panelQtyRangeEl.textContent = `(min ${min}, max ${max})`;

      productPanelEl.style.display = "block";
    }

    function closeProductPanel() {
      SELECTED_PRODUCT = null;
      productPanelEl.style.display = "none";
    }

    async function buySelectedProduct() {
      if (!SELECTED_PRODUCT || !CURRENT_USER) return;

      const qty = Number(panelQtyEl.value || 0);
      const prod = SELECTED_PRODUCT;

      panelStatusEl.textContent = "Se trimite comanda...";
      panelStatusEl.className = "status-bar";

      try {
        const res = await apiCall("buy_product", {
          product_id: prod.id,
          qty: qty,
        });

        if (!res.ok) {
          panelStatusEl.className = "status-bar status-error";
          if (res.error === "not_enough_credits") {
            panelStatusEl.textContent = `Nu ai suficiente credite (ai ${res.have}, ai nevoie de ${res.need}).`;
          } else if (res.error === "qty_out_of_range") {
            panelStatusEl.textContent = `Cantitate invalidă. Min ${res.min_qty}, max ${res.max_qty}.`;
          } else {
            panelStatusEl.textContent = "Eroare la cumpărare: " + (res.error || "necunoscută");
          }
          return;
        }

        CURRENT_USER.credits = res.new_balance;
        creditsValueEl.textContent = CURRENT_USER.credits;

        const newTicket = res.ticket;
        // adăugăm în listă și selectăm tichetul
        CURRENT_TICKETS.push(newTicket);
        renderTicketsList();
        selectTicket(newTicket.id);

        panelStatusEl.className = "status-bar status-ok";
        panelStatusEl.textContent = `Comandă trimisă, tichet #${newTicket.id} creat.`;

        // schimbăm tab-ul pe Tichete
        document.querySelector('.tab-btn[data-tab="ticketsTab"]').click();
      } catch (err) {
        console.error("buy_product error:", err);
        panelStatusEl.className = "status-bar status-error";
        panelStatusEl.textContent = "Eroare la comunicarea cu serverul.";
      }
    }

    panelCloseBtn.addEventListener("click", closeProductPanel);
    panelBuyBtn.addEventListener("click", buySelectedProduct);

    // CHAT

    const chatListEl = document.getElementById("chatList");
    const chatHeaderEl = document.getElementById("chatHeader");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const ticketsInfoEl = document.getElementById("ticketsInfo");

    function renderTicketsInfo() {
      if (!CURRENT_TICKETS || CURRENT_TICKETS.length === 0) {
        ticketsInfoEl.textContent =
          "Nu ai tichete deschise încă. Când cumperi un produs, se creează automat un tichet de chat cu administratorul.";
      } else {
        const openCount = CURRENT_TICKETS.filter((t) => t.status === "open")
          .length;
        ticketsInfoEl.innerHTML = `Ai <b>${CURRENT_TICKETS.length}</b> tichete, dintre care <b>${openCount}</b> deschise.`;
      }
    }

    function getTicketLastMessage(t) {
      const msgs = t.messages || [];
      if (msgs.length === 0) return "";
      return msgs[msgs.length - 1].text || "";
    }

    function renderTicketsList() {
      chatListEl.innerHTML = "";
      if (!CURRENT_TICKETS || CURRENT_TICKETS.length === 0) {
        chatListEl.innerHTML =
          '<div style="padding:6px;font-size:12px;color:var(--muted);">Nu ai tichete încă.</div>';
        return;
      }

      // sort: open first, then newest
      CURRENT_TICKETS.sort((a, b) => {
        if (a.status !== b.status) {
          return a.status === "open" ? -1 : 1;
        }
        return (b.id || 0) - (a.id || 0);
      });

      CURRENT_TICKETS.forEach((t) => {
        const item = document.createElement("div");
        item.className = "chat-item";
        if (t.id === SELECTED_TICKET_ID) item.classList.add("active");

        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = t.product_name || "Produs";

        const statusText = t.status === "open" ? "DESCHIS" : "ÎNCHIS";
        const lastMsg = getTicketLastMessage(t);

        const line = document.createElement("div");
        line.className = "chat-item-line";
        line.textContent = `[${statusText}] ${lastMsg}`;

        item.appendChild(title);
        item.appendChild(line);

        item.addEventListener("click", () => selectTicket(t.id));

        chatListEl.appendChild(item);
      });
    }

    function selectTicket(ticketId) {
      SELECTED_TICKET_ID = ticketId;
      renderTicketsList();

      const t = CURRENT_TICKETS.find((x) => x.id === ticketId);
      if (!t) {
        chatHeaderEl.innerHTML = "<span>Niciun tichet selectat</span>";
        chatMessagesEl.innerHTML = "";
        return;
      }

      chatHeaderEl.innerHTML = `
        <b>Tichet #${t.id}</b><br/>
        <span>${t.product_name} · ${t.qty} buc · total ${t.total_price} credite · status: ${t.status}</span>
      `;

      renderChatMessages(t);
    }

    function renderChatMessages(ticket) {
      const msgs = ticket.messages || [];
      chatMessagesEl.innerHTML = "";

      msgs.forEach((m) => {
        const row = document.createElement("div");
        row.className = "msg-row " + m.from;

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble " + m.from;
        bubble.textContent = m.text;

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.textContent = m.sender || "";

        bubble.appendChild(meta);
        row.appendChild(bubble);

        chatMessagesEl.appendChild(row);
      });

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function sendChatMessage() {
      const text = chatInputEl.value.trim();
      if (!text || !SELECTED_TICKET_ID) return;

      chatInputEl.value = "";

      try {
        const res = await apiCall("user_send_message", {
          ticket_id: SELECTED_TICKET_ID,
          text,
        });

        if (!res.ok) {
          console.error("user_send_message error:", res);
          return;
        }

        // updatăm ticket-ul în listă
        const updated = res.ticket;
        const idx = CURRENT_TICKETS.findIndex((t) => t.id === updated.id);
        if (idx >= 0) {
          CURRENT_TICKETS[idx] = updated;
        } else {
          CURRENT_TICKETS.push(updated);
        }

        renderTicketsList();
        selectTicket(updated.id);
      } catch (err) {
        console.error("user_send_message error:", err);
      }
    }

    chatSendBtn.addEventListener("click", sendChatMessage);
    chatInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChatMessage();
      }
    });

    // Polling user tickets
    async function pollTickets() {
      if (!CURRENT_USER) return;
      try {
        const res = await apiCall("user_get_tickets", {});
        if (!res.ok) return;
        CURRENT_TICKETS = res.tickets || [];
        renderTicketsList();
        renderTicketsInfo();

        if (SELECTED_TICKET_ID) {
          const t = CURRENT_TICKETS.find((x) => x.id === SELECTED_TICKET_ID);
          if (t) {
            selectTicket(t.id);
          }
        }
      } catch (err) {
        console.error("user_get_tickets error:", err);
      }
    }

    // INIT
    async function initApp() {
      if (!tg) {
        userLineEl.textContent =
          "Nu ești în Telegram MiniApp. Deschide link-ul prin bot.";
        return;
      }

      tg.ready();
      tg.expand();

      const user = tg.initDataUnsafe?.user;
      if (!user) {
        userLineEl.textContent =
          "Telegram nu a trimis datele userului. Deschide MiniApp-ul din butonul inline.";
        return;
      }

      CURRENT_USER = {
        id: user.id,
        username: user.username || null,
        first_name: user.first_name || null,
        last_name: user.last_name || null,
        credits: 0,
      };

      try {
        const res = await apiCall("init", {});
        if (!res.ok) {
          userLineEl.textContent =
            "Eroare la inițializare (server nu a răspuns ok).";
          return;
        }

        CURRENT_USER.credits = res.user.credits;
        CURRENT_USER.username = res.user.username;

        CURRENT_SHOP = res.shop;
        CURRENT_TICKETS = res.tickets || [];

        renderUserHeader();
        renderShop(CURRENT_SHOP);
        renderTicketsList();
        renderTicketsInfo();

        // pornește polling
        POLL_INTERVAL = setInterval(pollTickets, 3000);
      } catch (err) {
        console.error("init error:", err);
        userLineEl.textContent = "Eroare la inițializare (network).";
      }
    }

    initApp();
  </script>
</body>
</html>
