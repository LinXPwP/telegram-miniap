<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Profil – MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-brand">
        <div class="brand-logo"><span>U</span></div>
        <div class="brand-text">
          <h1>Profil</h1>
          <p id="subtitle">Se încarcă profilul...</p>
        </div>
      </div>
      <div id="role-chip" class="role-chip" style="display:none;">
        <span class="role-dot"></span>
        <span id="role-text">USER</span>
      </div>
    </header>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Date utilizator</div>
          <div class="card-sub">Din Telegram</div>
        </div>
        <div id="user-id" class="badge-id">ID: -</div>
      </div>

      <div class="info-row">
        <div class="info-label">Username</div>
        <div id="username" class="info-value">loading...</div>
      </div>

      <div class="info-row">
        <div class="info-label">Nume</div>
        <div id="name" class="info-value">-</div>
      </div>

      <div class="info-row">
        <div class="info-label">Status</div>
        <div id="status" class="info-value">Utilizator</div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Credite</div>
          <div class="card-sub">Soldul disponibil</div>
        </div>
      </div>

      <div class="info-row">
        <div class="info-label">Total</div>
        <div id="credits" class="info-value credits">0</div>
      </div>
      <div id="profile-error" class="error-text" style="display:none;"></div>
    </section>

    <section class="card" id="tickets-card">
      <div class="card-header">
        <div>
          <div class="card-title">Tickete (comenzi)</div>
          <div class="card-sub">Ultimele comenzi făcute</div>
        </div>
      </div>
      <div id="tickets-container">
        <div class="skeleton skeleton-line"></div>
        <div class="skeleton skeleton-line short"></div>
      </div>
    </section>

    <section class="card" id="admin-card" style="display:none;">
      <div class="card-header">
        <div>
          <div class="card-title">Admin Panel</div>
          <div class="card-sub">Deschide dashboard-ul complet</div>
        </div>
      </div>
      <div class="admin-actions-row admin-actions-bottom">
        <button id="btn-open-admin" class="btn btn-primary" type="button">
          Deschide Admin Website
        </button>
      </div>
      <div class="product-desc" style="margin-top:6px;">
        Se deschide un website separat cu token secret, doar pentru administrator.
      </div>
    </section>

    <div class="footer">
      Navighează: Shop • Profil • Admin (doar admin)
    </div>
  </div>

  <nav class="tabbar" style="margin-top:8px;">
    <a class="tab-btn" href="index.html">Shop</a>
    <a class="tab-btn active">Profil</a>
    <a id="nav-admin" class="tab-btn hidden">Admin</a>
  </nav>

  <div id="toast" class="toast"></div>

  <script>
    (function () {
      const tg = window.Telegram.WebApp;
      if (tg && tg.expand) tg.expand();

      const ADMIN_ID = 7672256597;
      const API_BASE = "https://melodic-mandazi-7a16dc.netlify.app/.netlify/functions";

      const subtitle = document.getElementById("subtitle");
      const userIdEl = document.getElementById("user-id");
      const usernameEl = document.getElementById("username");
      const nameEl = document.getElementById("name");
      const statusEl = document.getElementById("status");
      const creditsEl = document.getElementById("credits");
      const errorEl = document.getElementById("profile-error");
      const roleChip = document.getElementById("role-chip");
      const roleText = document.getElementById("role-text");
      const ticketsContainer = document.getElementById("tickets-container");
      const adminCard = document.getElementById("admin-card");
      const btnOpenAdmin = document.getElementById("btn-open-admin");
      const navAdmin = document.getElementById("nav-admin");
      const toastEl = document.getElementById("toast");

      function toast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 2000);
      }

      function safeFetch(url) {
        return fetch(url).then(res => {
          if (!res.ok) return res.text().then(t => { throw new Error(t || res.status); });
          return res.json();
        });
      }

      let user = null;
      try {
        user = tg && tg.initDataUnsafe && tg.initDataUnsafe.user;
      } catch (e) {
        console.error(e);
      }

      if (!user) {
        subtitle.textContent = "Deschide miniapp-ul din Telegram.";
        errorEl.style.display = "block";
        errorEl.textContent = "User necunoscut.";
        return;
      }

      const fullUsername = user.username ? "@" + user.username : "(fără username)";
      const fullName = [user.first_name || "", user.last_name || ""].join(" ").trim();

      usernameEl.textContent = fullUsername;
      nameEl.textContent = fullName || "–";
      userIdEl.textContent = "ID: " + user.id;

      const isAdminClient = user.id === ADMIN_ID;
      if (isAdminClient) {
        statusEl.textContent = "Administrator";
        roleChip.style.display = "inline-flex";
        roleText.textContent = "ADMIN";
        adminCard.style.display = "block";
        navAdmin.classList.remove("hidden");
      } else {
        statusEl.textContent = "Utilizator normal";
      }

      subtitle.textContent = "Se încarcă creditele & ticketele...";

      // credite
      safeFetch(API_BASE + "/get_credits?user_id=" + encodeURIComponent(user.id))
        .then(data => {
          creditsEl.textContent = data.credits ?? 0;
          if (data.is_admin) {
            statusEl.textContent = "Administrator";
            roleChip.style.display = "inline-flex";
            roleText.textContent = "ADMIN";
            adminCard.style.display = "block";
            navAdmin.classList.remove("hidden");
          }
          subtitle.textContent = "Profil încărcat.";
        })
        .catch(err => {
          console.error(err);
          errorEl.style.display = "block";
          errorEl.textContent = "Nu s-au putut încărca creditele.";
          subtitle.textContent = "Eroare la API-ul de credite.";
        });

      // tickete
      safeFetch(API_BASE + "/user_tickets?user_id=" + encodeURIComponent(user.id))
        .then(data => {
          renderTickets(data.tickets || []);
        })
        .catch(err => {
          console.error(err);
          ticketsContainer.innerHTML =
            '<div class="error-text">Nu s-au putut încărca ticketele.</div>';
        });

      function renderTickets(list) {
        if (!list.length) {
          ticketsContainer.innerHTML =
            '<div class="product-desc">Nu ai tickete încă. Cumpără un produs din shop.</div>';
          return;
        }

        ticketsContainer.innerHTML = "";
        list.forEach(t => {
          const div = document.createElement("div");
          div.className = "product-item";

          const top = document.createElement("div");
          top.className = "product-top";

          const left = document.createElement("div");
          left.className = "product-name";
          left.textContent = t.product_name || "Produs";

          const right = document.createElement("div");
          right.className = "product-price";
          right.textContent = "#" + t.id;

          top.appendChild(left);
          top.appendChild(right);
          div.appendChild(top);

          const desc = document.createElement("div");
          desc.className = "product-desc";
          desc.textContent =
            "Cantitate: " +
            t.qty +
            " • Total: " +
            t.total_price +
            " cr. • Status: " +
            (t.status || "open");
          div.appendChild(desc);

          const date = document.createElement("div");
          date.className = "product-limits";
          date.textContent = t.created_at || "";
          div.appendChild(date);

          ticketsContainer.appendChild(div);
        });
      }

      // admin panel
      btnOpenAdmin.onclick = () => {
        safeFetch(
          API_BASE + "/admin_panel_url?user_id=" + encodeURIComponent(user.id)
        )
          .then(data => {
            if (!data.url) throw new Error("no url");
            window.open(data.url, "_blank");
          })
          .catch(err => {
            console.error(err);
            toast("Nu s-a putut obține linkul de admin.");
          });
      };
    })();
  </script>
</body>
</html>
