<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard – Chat & Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #050509;
      --bg-card: #111111;
      --accent: #e50914;
      --accent-soft: #ff4b5c;
      --accent-muted: #8b0000;
      --text: #f5f5f5;
      --muted: #aaaaaa;
      --border: #222222;
      --bubble-user: #1f2933;
      --bubble-admin: #8b0000;
      --bubble-system: #333333;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #1a1a1a 0, #000 55%, #050509 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 12px 8px 18px;
    }

    .card {
      background: rgba(10, 10, 14, 0.96);
      border-radius: 18px;
      padding: 10px 10px 12px;
      border: 1px solid rgba(229, 9, 20, 0.5);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: radial-gradient(
        circle at top left,
        var(--accent-soft),
        var(--accent)
      );
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #fff;
    }

    h1 {
      margin: 4px 0 2px;
      font-size: 18px;
    }

    .subtitle {
      margin: 0 0 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .user-line {
      font-size: 12px;
      margin-bottom: 8px;
      color: var(--muted);
    }

    .tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .tab-btn {
      flex: 1;
      font-size: 12px;
      padding: 6px 4px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #080808;
      color: var(--muted);
      cursor: pointer;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      border-color: transparent;
      font-weight: 600;
    }

    .tab-section {
      display: none;
    }
    .tab-section.active {
      display: block;
    }

    .section-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin: 4px 0;
    }

    /* CHAT */

    .chat-admin-layout {
      display: grid;
      grid-template-columns: 0.9fr 1.7fr;
      gap: 6px;
      max-height: 420px;
    }

    .chat-sidebar {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #08080b;
      overflow: auto;
      font-size: 12px;
    }

    .chat-item {
      padding: 6px 6px;
      border-bottom: 1px solid #151515;
      cursor: pointer;
    }

    .chat-item.active {
      background: rgba(229, 9, 20, 0.25);
      border-left: 3px solid var(--accent-soft);
    }

    .chat-item-title {
      font-weight: 600;
      font-size: 12px;
    }

    .chat-item-line {
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-main {
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #050509;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 6px 8px;
      border-bottom: 1px solid #151515;
      font-size: 12px;
    }

    .chat-header span {
      color: var(--muted);
    }

    .chat-messages {
      flex: 1;
      padding: 6px 6px 4px;
      overflow-y: auto;
      font-size: 12px;
    }

    .msg-row {
      margin-bottom: 4px;
      display: flex;
    }

    .msg-row.user {
      justify-content: flex-start;
    }

    .msg-row.admin {
      justify-content: flex-end;
    }

    .msg-row.system {
      justify-content: center;
    }

    .msg-bubble {
      max-width: 80%;
      padding: 5px 7px;
      border-radius: 12px;
      position: relative;
      font-size: 12px;
      line-height: 1.3;
    }

    .msg-bubble.user {
      background: var(--bubble-user);
      border-bottom-left-radius: 2px;
    }

    .msg-bubble.admin {
      background: var(--bubble-admin);
      border-bottom-right-radius: 2px;
    }

    .msg-bubble.system {
      background: var(--bubble-system);
      border-radius: 999px;
      font-size: 11px;
      color: var(--muted);
    }

    .msg-meta {
      font-size: 9px;
      opacity: 0.7;
      margin-top: 2px;
      text-align: left;
    }

    .chat-input {
      border-top: 1px solid #151515;
      padding: 4px 4px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .chat-input input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 5px 8px;
      font-size: 12px;
    }

    .chat-input button {
      border-radius: 999px;
      border: none;
      padding: 6px 9px;
      font-size: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      cursor: pointer;
    }

    .ticket-details {
      margin-top: 6px;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      background: rgba(0, 0, 0, 0.6);
      font-size: 12px;
    }

    .ticket-details label {
      font-size: 11px;
      color: var(--muted);
    }

    .ticket-details textarea {
      width: 100%;
      min-height: 50px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 6px;
      font-size: 12px;
      resize: vertical;
    }

    .ticket-details select {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 4px 8px;
      font-size: 12px;
    }

    .btn-primary {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-soft));
      color: #fff;
      cursor: pointer;
    }

    .btn-ghost {
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid var(--border);
      background: #050505;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
    }

    .status-bar {
      margin-top: 4px;
      font-size: 11px;
      min-height: 14px;
      color: var(--muted);
    }

    .status-ok {
      color: #4caf50;
    }

    .status-error {
      color: #ff5252;
    }

    /* SHOP */

    .shop-container {
      max-height: 420px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px;
      background: rgba(5, 5, 8, 0.8);
    }

    .cat-card {
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 8px;
      margin-bottom: 6px;
      background: #090909;
    }

    .cat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .cat-header input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 5px 8px;
      font-size: 12px;
    }

    .cat-desc {
      margin-top: 4px;
    }
    .cat-desc textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 5px;
      font-size: 12px;
      min-height: 40px;
      resize: vertical;
    }

    .products-list {
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid #202020;
      padding: 5px;
      background: #080808;
    }

    .product-row {
      display: grid;
      grid-template-columns: 1.5fr 0.7fr 0.7fr 0.7fr auto;
      gap: 4px;
      margin-bottom: 4px;
      align-items: center;
    }

    .product-row input {
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #050505;
      color: var(--text);
      padding: 4px 5px;
      font-size: 11px;
      width: 100%;
    }

    .product-mini-actions {
      display: flex;
      gap: 4px;
    }

    .small-input-label {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .footer {
      margin-top: 8px;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .dot-red {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px var(--accent);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header-top">
        <div class="badge">
          <span class="badge-dot"></span>
          <span>Admin dashboard</span>
        </div>
        <div style="font-size: 11px; color: var(--muted);" id="envInfo">
          MiniApp Admin (token)
        </div>
      </div>

      <h1>Panou administrator</h1>
      <p class="subtitle">
        Vezi toate tichetele de chat, răspunde utilizatorilor și administrează structura shop-ului.
      </p>

      <p class="user-line" id="userLine">Verific token...</p>

      <div class="tabs">
        <button class="tab-btn active" data-tab="chatTab">Chat-uri tichete</button>
        <button class="tab-btn" data-tab="shopTab">Shop</button>
      </div>

      <!-- CHAT TAB -->
      <div id="chatTab" class="tab-section active">
        <div class="section-title">Toate tichetele</div>
        <div class="chat-admin-layout">
          <div class="chat-sidebar" id="ticketsList"></div>
          <div class="chat-main">
            <div class="chat-header" id="chatHeader">
              <span>Niciun tichet selectat</span>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input">
              <input
                id="chatInput"
                placeholder="Răspunde utilizatorului..."
                autocomplete="off"
              />
              <button id="chatSendBtn">Trimite</button>
            </div>
          </div>
        </div>

        <div class="ticket-details" id="ticketDetails" style="display:none;">
          <div id="ticketSummary" style="margin-bottom: 4px;"></div>
          <div style="margin-bottom: 4px;">
            <label for="ticketStatusSelect">Status tichet:</label><br />
            <select id="ticketStatusSelect">
              <option value="open">Deschis</option>
              <option value="closed">Închis</option>
            </select>
          </div>
          <div>
            <label for="ticketNote">Notă internă:</label><br />
            <textarea id="ticketNote"></textarea>
          </div>
          <div style="margin-top: 4px; display: flex; gap: 6px;">
            <button class="btn-primary" id="ticketSaveBtn">Salvează</button>
            <button class="btn-ghost" id="ticketCloseBtn">Închide tichet</button>
          </div>
          <div class="status-bar" id="ticketStatusBar"></div>
        </div>
      </div>

      <!-- SHOP TAB -->
      <div id="shopTab" class="tab-section">
        <div class="section-title">Categorii & produse</div>
        <div class="shop-container" id="shopContainer"></div>
        <div style="margin-top: 6px; display:flex; gap:6px; justify-content:space-between;">
          <button class="btn-ghost" id="addCategoryBtn">+ Categorie</button>
          <button class="btn-primary" id="saveShopBtn">Salvează shop</button>
        </div>
        <div class="status-bar" id="shopStatusBar"></div>
      </div>

      <div class="footer">
        <span>v0.3 – admin chat & shop</span>
        <span class="dot-red"></span>
      </div>
    </div>
  </div>

  <script>
    const API_URL =
      "https://dancing-hotteok-480e3c.netlify.app/.netlify/functions/api";

    const params = new URLSearchParams(window.location.search);
    const ADMIN_TOKEN = params.get("token") || "";

    const userLineEl = document.getElementById("userLine");

    const ticketsListEl = document.getElementById("ticketsList");
    const chatHeaderEl = document.getElementById("chatHeader");
    const chatMessagesEl = document.getElementById("chatMessages");
    const chatInputEl = document.getElementById("chatInput");
    const chatSendBtn = document.getElementById("chatSendBtn");
    const ticketDetailsEl = document.getElementById("ticketDetails");
    const ticketSummaryEl = document.getElementById("ticketSummary");
    const ticketStatusSelect = document.getElementById("ticketStatusSelect");
    const ticketNoteEl = document.getElementById("ticketNote");
    const ticketStatusBarEl = document.getElementById("ticketStatusBar");

    const shopContainerEl = document.getElementById("shopContainer");
    const shopStatusBarEl = document.getElementById("shopStatusBar");
    const addCategoryBtn = document.getElementById("addCategoryBtn");
    const saveShopBtn = document.getElementById("saveShopBtn");
    const ticketSaveBtn = document.getElementById("ticketSaveBtn");
    const ticketCloseBtn = document.getElementById("ticketCloseBtn");

    let ALL_TICKETS = [];
    let CURRENT_SHOP = null;
    let SELECTED_TICKET_ID = null;
    let POLL_INTERVAL = null;

    // Tabs
    document.querySelectorAll(".tab-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const target = btn.getAttribute("data-tab");
        document
          .querySelectorAll(".tab-section")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById(target).classList.add("active");
      });
    });

    function apiCall(action, extraPayload = {}) {
      const payload = {
        action,
        token: ADMIN_TOKEN,
        ...extraPayload,
      };
      return fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }).then((r) => r.json());
    }

    function renderTokenInfo() {
      if (!ADMIN_TOKEN) {
        userLineEl.innerHTML =
          "<span style='color:#ff5252;'>Token lipsă în URL.</span> Deschide admin.html?token=TOKENUL_TAU.";
      } else {
        const short = ADMIN_TOKEN.slice(0, 4) + "..." + ADMIN_TOKEN.slice(-4);
        userLineEl.innerHTML = "Acces cu token: <b>" + short + "</b>";
      }
    }

    // CHAT

    function getTicketLastMessage(t) {
      const msgs = t.messages || [];
      if (msgs.length === 0) return "";
      return msgs[msgs.length - 1].text || "";
    }

    function renderTicketsList() {
      ticketsListEl.innerHTML = "";
      if (!ALL_TICKETS || ALL_TICKETS.length === 0) {
        ticketsListEl.innerHTML =
          '<div style="padding:6px;font-size:12px;color:var(--muted);">Nu există tichete încă.</div>';
        ticketDetailsEl.style.display = "none";
        chatHeaderEl.innerHTML = "<span>Niciun tichet selectat</span>";
        chatMessagesEl.innerHTML = "";
        return;
      }

      ALL_TICKETS.sort((a, b) => {
        if (a.status !== b.status) {
          return a.status === "open" ? -1 : 1;
        }
        return (b.id || 0) - (a.id || 0);
      });

      ALL_TICKETS.forEach((t) => {
        const item = document.createElement("div");
        item.className = "chat-item";
        if (t.id === SELECTED_TICKET_ID) item.classList.add("active");

        const title = document.createElement("div");
        title.className = "chat-item-title";
        title.textContent = (t.username || t.user_id) + " · " + (t.product_name || "");

        const statusText = t.status === "open" ? "DESCHIS" : "ÎNCHIS";
        const lastMsg = getTicketLastMessage(t);

        const line = document.createElement("div");
        line.className = "chat-item-line";
        line.textContent = `[${statusText}] ${lastMsg}`;

        item.appendChild(title);
        item.appendChild(line);

        item.addEventListener("click", () => selectTicket(t.id));

        ticketsListEl.appendChild(item);
      });
    }

    function selectTicket(ticketId) {
      SELECTED_TICKET_ID = ticketId;
      renderTicketsList();

      const t = ALL_TICKETS.find((x) => x.id === ticketId);
      if (!t) {
        ticketDetailsEl.style.display = "none";
        chatHeaderEl.innerHTML = "<span>Niciun tichet selectat</span>";
        chatMessagesEl.innerHTML = "";
        return;
      }

      chatHeaderEl.innerHTML = `
        <b>Tichet #${t.id}</b><br/>
        <span>User: ${t.username || t.user_id} · Produs: ${
        t.product_name
      } · ${t.qty} buc · total ${t.total_price} credite · status: ${
        t.status
      }</span>
      `;

      renderChatMessages(t);

      ticketDetailsEl.style.display = "block";
      ticketSummaryEl.innerHTML = `
        <b>Tichet #${t.id}</b><br/>
        User: <b>${t.username || t.user_id}</b><br/>
        Produs: <b>${t.product_name}</b> (${t.qty} buc, total ${
        t.total_price
      } credite)
      `;
      ticketStatusSelect.value = t.status || "open";
      ticketNoteEl.value = t.note || "";
      ticketStatusBarEl.textContent = "";
      ticketStatusBarEl.className = "status-bar";
    }

    function renderChatMessages(ticket) {
      const msgs = ticket.messages || [];
      chatMessagesEl.innerHTML = "";

      msgs.forEach((m) => {
        const row = document.createElement("div");
        row.className = "msg-row " + m.from;

        const bubble = document.createElement("div");
        bubble.className = "msg-bubble " + m.from;
        bubble.textContent = m.text;

        const meta = document.createElement("div");
        meta.className = "msg-meta";
        meta.textContent = `${m.sender || ""}`;

        bubble.appendChild(meta);
        row.appendChild(bubble);

        chatMessagesEl.appendChild(row);
      });

      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    async function sendAdminMessage() {
      const text = chatInputEl.value.trim();
      if (!text || !SELECTED_TICKET_ID) return;

      chatInputEl.value = "";

      try {
        const res = await apiCall("admin_send_message", {
          ticket_id: SELECTED_TICKET_ID,
          text,
          sender: "Admin",
        });

        if (!res.ok) {
          console.error("admin_send_message error:", res);
          return;
        }

        const updated = res.ticket;
        const idx = ALL_TICKETS.findIndex((t) => t.id === updated.id);
        if (idx >= 0) {
          ALL_TICKETS[idx] = updated;
        } else {
          ALL_TICKETS.push(updated);
        }

        renderTicketsList();
        selectTicket(updated.id);
      } catch (err) {
        console.error("admin_send_message error:", err);
      }
    }

    chatSendBtn.addEventListener("click", sendAdminMessage);
    chatInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendAdminMessage();
      }
    });

    async function saveSelectedTicket(closed = false) {
      if (!SELECTED_TICKET_ID) return;
      const t = ALL_TICKETS.find((x) => x.id === SELECTED_TICKET_ID);
      if (!t) return;

      const newStatus = closed ? "closed" : ticketStatusSelect.value;
      const note = ticketNoteEl.value || "";

      ticketStatusBarEl.textContent = "Se salvează tichetul...";
      ticketStatusBarEl.className = "status-bar";

      try {
        const res = await apiCall("admin_update_ticket", {
          ticket_id: t.id,
          status: newStatus,
          note: note,
        });

        if (!res.ok) {
          ticketStatusBarEl.textContent =
            "Eroare la salvare: " + (res.error || "necunoscută");
          ticketStatusBarEl.className = "status-bar status-error";
          return;
        }

        t.status = newStatus;
        t.note = note;

        ticketStatusBarEl.textContent = "Tichet salvat.";
        ticketStatusBarEl.className = "status-bar status-ok";

        renderTicketsList();
      } catch (err) {
        console.error("admin_update_ticket error:", err);
        ticketStatusBarEl.textContent =
          "Eroare la comunicarea cu serverul.";
        ticketStatusBarEl.className = "status-bar status-error";
      }
    }

    ticketSaveBtn.addEventListener("click", () => saveSelectedTicket(false));
    ticketCloseBtn.addEventListener("click", () => saveSelectedTicket(true));

    // SHOP EDITOR

    function renderShopEditor() {
      shopContainerEl.innerHTML = "";
      if (!CURRENT_SHOP || !CURRENT_SHOP.categories) {
        shopContainerEl.innerHTML =
          '<div style="font-size:12px;color:var(--muted);">Nu există categorii. Adaugă una nouă.</div>';
        return;
      }

      CURRENT_SHOP.categories.forEach((cat, catIndex) => {
        const catDiv = document.createElement("div");
        catDiv.className = "cat-card";

        const header = document.createElement("div");
        header.className = "cat-header";

        const nameInput = document.createElement("input");
        nameInput.placeholder = "Nume categorie";
        nameInput.value = cat.name || "";
        nameInput.addEventListener("input", () => {
          cat.name = nameInput.value;
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-ghost";
        deleteBtn.textContent = "Șterge";
        deleteBtn.style.fontSize = "11px";
        deleteBtn.onclick = () => {
          if (confirm("Ștergi categoria?")) {
            CURRENT_SHOP.categories.splice(catIndex, 1);
            renderShopEditor();
          }
        };

        header.appendChild(nameInput);
        header.appendChild(deleteBtn);

        const descDiv = document.createElement("div");
        descDiv.className = "cat-desc";
        const descArea = document.createElement("textarea");
        descArea.placeholder = "Descriere categorie";
        descArea.value = cat.description || "";
        descArea.addEventListener("input", () => {
          cat.description = descArea.value;
        });
        descDiv.appendChild(descArea);

        const productsWrap = document.createElement("div");
        productsWrap.className = "products-list";

        (cat.products = cat.products || []).forEach((prod, prodIndex) => {
          const row = document.createElement("div");
          row.className = "product-row";

          const colName = document.createElement("div");
          const nameInputProd = document.createElement("input");
          nameInputProd.placeholder = "Nume produs";
          nameInputProd.value = prod.name || "";
          nameInputProd.addEventListener("input", () => {
            prod.name = nameInputProd.value;
          });
          const nameLabel = document.createElement("div");
          nameLabel.className = "small-input-label";
          nameLabel.textContent = "Nume";
          colName.appendChild(nameInputProd);
          colName.appendChild(nameLabel);

          const colPrice = document.createElement("div");
          const priceInput = document.createElement("input");
          priceInput.type = "number";
          priceInput.placeholder = "Preț";
          priceInput.value = prod.price || 0;
          priceInput.addEventListener("input", () => {
            prod.price = Number(priceInput.value || 0);
          });
          const priceLabel = document.createElement("div");
          priceLabel.className = "small-input-label";
          priceLabel.textContent = "Preț";
          colPrice.appendChild(priceInput);
          colPrice.appendChild(priceLabel);

          const colMin = document.createElement("div");
          const minInput = document.createElement("input");
          minInput.type = "number";
          minInput.placeholder = "Min";
          minInput.value = prod.min_qty || 1;
          minInput.addEventListener("input", () => {
            prod.min_qty = Number(minInput.value || 1);
          });
          const minLabel = document.createElement("div");
          minLabel.className = "small-input-label";
          minLabel.textContent = "Min";
          colMin.appendChild(minInput);
          colMin.appendChild(minLabel);

          const colMax = document.createElement("div");
          const maxInput = document.createElement("input");
          maxInput.type = "number";
          maxInput.placeholder = "Max";
          maxInput.value = prod.max_qty || prod.min_qty || 1;
          maxInput.addEventListener("input", () => {
            prod.max_qty = Number(maxInput.value || prod.min_qty || 1);
          });
          const maxLabel = document.createElement("div");
          maxLabel.className = "small-input-label";
          maxLabel.textContent = "Max";
          colMax.appendChild(maxInput);
          colMax.appendChild(maxLabel);

          const colActions = document.createElement("div");
          colActions.className = "product-mini-actions";
          const delProdBtn = document.createElement("button");
          delProdBtn.className = "btn-ghost";
          delProdBtn.style.fontSize = "10px";
          delProdBtn.textContent = "X";
          delProdBtn.onclick = () => {
            if (confirm("Ștergi produsul?")) {
              cat.products.splice(prodIndex, 1);
              renderShopEditor();
            }
          };
          colActions.appendChild(delProdBtn);

          row.appendChild(colName);
          row.appendChild(colPrice);
          row.appendChild(colMin);
          row.appendChild(colMax);
          row.appendChild(colActions);

          productsWrap.appendChild(row);

          const descRow = document.createElement("div");
          descRow.style.gridColumn = "1 / -1";
          descRow.style.marginBottom = "4px";
          const descInput = document.createElement("input");
          descInput.placeholder = "Descriere produs";
          descInput.value = prod.description || "";
          descInput.addEventListener("input", () => {
            prod.description = descInput.value;
          });
          descRow.appendChild(descInput);
          productsWrap.appendChild(descRow);
        });

        const addProdBtn = document.createElement("button");
        addProdBtn.className = "btn-ghost";
        addProdBtn.style.fontSize = "11px";
        addProdBtn.textContent = "+ Produs";
        addProdBtn.onclick = () => {
          cat.products.push({
            id: "prod_" + Date.now(),
            name: "Produs nou",
            price: 0,
            description: "",
            min_qty: 1,
            max_qty: 1,
          });
          renderShopEditor();
        };

        productsWrap.appendChild(addProdBtn);

        catDiv.appendChild(header);
        catDiv.appendChild(descDiv);
        catDiv.appendChild(productsWrap);

        shopContainerEl.appendChild(catDiv);
      });
    }

    async function saveShop() {
      if (!CURRENT_SHOP) return;
      shopStatusBarEl.textContent = "Se salvează shop-ul...";
      shopStatusBarEl.className = "status-bar";

      try {
        const res = await apiCall("admin_save_shop", { shop: CURRENT_SHOP });
        if (!res.ok) {
          shopStatusBarEl.textContent =
            "Eroare la salvare: " + (res.error || "necunoscută");
          shopStatusBarEl.className = "status-bar status-error";
          return;
        }
        shopStatusBarEl.textContent = "Shop salvat.";
        shopStatusBarEl.className = "status-bar status-ok";
      } catch (err) {
        console.error("admin_save_shop error:", err);
        shopStatusBarEl.textContent = "Eroare la comunicarea cu serverul.";
        shopStatusBarEl.className = "status-bar status-error";
      }
    }

    function addCategory() {
      if (!CURRENT_SHOP) CURRENT_SHOP = { categories: [] };
      CURRENT_SHOP.categories.push({
        id: "cat_" + Date.now(),
        name: "Categorie nouă",
        description: "",
        products: [],
      });
      renderShopEditor();
    }

    // Polling admin tickets
    async function pollAdminTickets() {
      if (!ADMIN_TOKEN) return;
      try {
        const res = await apiCall("admin_get_tickets", {});
        if (!res.ok) {
          if (res.error === "forbidden") {
            userLineEl.innerHTML =
              "<span style='color:#ff5252;'>Token invalid.</span>";
          }
          return;
        }
        ALL_TICKETS = res.tickets || [];
        CURRENT_SHOP = res.shop || { categories: [] };

        renderTicketsList();
        renderShopEditor();

        if (SELECTED_TICKET_ID) {
          const t = ALL_TICKETS.find((x) => x.id === SELECTED_TICKET_ID);
          if (t) {
            selectTicket(t.id);
          }
        }
      } catch (err) {
        console.error("admin_get_tickets error:", err);
        userLineEl.innerHTML =
          "<span style='color:#ff5252;'>Eroare la rețea.</span>";
      }
    }

    addCategoryBtn.addEventListener("click", addCategory);
    saveShopBtn.addEventListener("click", saveShop);

    // INIT
    async function initAdmin() {
      renderTokenInfo();
      if (!ADMIN_TOKEN) return;
      await pollAdminTickets();
      POLL_INTERVAL = setInterval(pollAdminTickets, 3000);
    }

    initAdmin();
  </script>
</body>
</html>
